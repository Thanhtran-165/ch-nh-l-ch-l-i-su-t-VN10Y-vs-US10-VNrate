//@version=5
indicator("MacroAcademic - VN Economy Engine v1.2.8 (PCTL Complete)",
     shorttitle="MacroAcademic VN v1.2.8",
     overlay=false,
     max_labels_count=500,
     max_lines_count=500,
     max_bars_back=5000,
     precision=4)

// =====================================================
// A) CONTROLS
// =====================================================
panel       = input.int(1, "Panel dang xem (1..7) | moi instance = 1 panel", minval=1, maxval=7)
displayMode = input.string("Full", "Che do hien thi", options=["Full","Compact","Chi Bang"])
robustMode  = input.string("Shock-sensitive", "Robust mode", options=["Shock-sensitive","Fully-robust MAD"])

useDrivers     = input.bool(true,  "Bat Drivers (PPI+FX+Oil)")
useYieldCurve  = input.bool(true,  "Bat Yield curve (VN10Y-VN02Y)")
useExternalBOT = input.bool(false, "Them BOT (can can thuong mai)")
useEvaluation  = input.bool(true,  "Bat Evaluation (MAE/RMSE/Churn)")

tblPosOpt   = input.string("Top Right", "Vi tri bang", options=["Top Right","Top Left","Bottom Right","Bottom Left"])
fontOpt     = input.string("Small", "Co chu bang", options=["Tiny","Small","Normal"])

pctlColorOn     = input.bool(true, "To mau PCTL")
riskColorOn     = input.bool(true, "To mau Risk")
showLineLabels  = input.bool(true, "Hien nhan duong (chi Panel 1)")
debugOn         = input.bool(true, "DEBUG (bat san)")

// =====================================================
// B) SYMBOLS (Editable)
// =====================================================
sym_infl  = input.symbol("ECONOMICS:VNIRYY",  "Lam phat YoY (Thang)")
sym_pol   = input.symbol("ECONOMICS:VNINTR",  "Lai suat dieu hanh (Ngay)")
sym_ib    = input.symbol("ECONOMICS:VNINBR",  "Lai suat lien ngan hang (Ngay)")
sym_gdp   = input.symbol("ECONOMICS:VNGDPYY", "GDP YoY (Quy)")

sym_ppi   = input.symbol("ECONOMICS:VNPPI",   "PPI (Quy)")
sym_fx    = input.symbol("FX_IDC:USDVND",     "USDVND (Ngay)")
sym_oil   = input.symbol("TVC:UKOIL",         "Dau Brent proxy (Ngay)")

sym_vn10y = input.symbol("TVC:VN10Y",         "VN 10Y (Ngay)")
sym_vn02y = input.symbol("TVC:VN02Y",         "VN 2Y (Ngay)")

sym_bot   = input.symbol("ECONOMICS:VNBOT",   "BOT (Thang)")

// =====================================================
// C) PARAMETERS
// =====================================================
infl_trend_len_m = input.int(24, "Trend lam phat (thang)", minval=6, maxval=120)
infl_z_len_m     = input.int(60, "Lookback (thang)", minval=24, maxval=240)
infl_clip        = input.float(2.5, "Clip (infl)", minval=1.5, maxval=6.0, step=0.1)

ewma_lambda      = input.float(0.30, "EWMA lambda", minval=0.05, maxval=0.95, step=0.01)
ar1_len_m        = input.int(60, "AR1 lookback (thang)", minval=24, maxval=240)
w_trend          = input.float(0.40, "Trong so Trend", minval=0.0, maxval=1.0, step=0.05)
w_ewma           = input.float(0.30, "Trong so EWMA",  minval=0.0, maxval=1.0, step=0.05)
w_ar1            = input.float(0.30, "Trong so AR1",   minval=0.0, maxval=1.0, step=0.05)

rreal_ema_len_m  = input.int(12, "EMA lai thuc (thang)", minval=3, maxval=60)
rate_z_len_m     = input.int(60, "Lookback (rate)", minval=24, maxval=240)
rate_clip        = input.float(2.5, "Clip (rate)", minval=1.5, maxval=6.0, step=0.1)

gdp_trend_len_q  = input.int(12, "Trend GDP (quy)", minval=4, maxval=40)
gdp_z_len_q      = input.int(40, "Lookback GDP (quy)", minval=16, maxval=120)
gdp_clip         = input.float(2.5, "Clip (GDP)", minval=1.5, maxval=6.0, step=0.1)

drv_z_len_m      = input.int(60, "Lookback drivers", minval=24, maxval=240)
drv_clip         = input.float(2.5, "Clip (drivers)", minval=1.5, maxval=6.0, step=0.1)
ppi_trend_len_q  = input.int(12, "Trend PPI (quy)", minval=4, maxval=40)
ppi_z_len_q      = input.int(40, "Lookback PPI (quy)", minval=16, maxval=120)

pi_target        = input.float(4.0, "Muc tieu lam phat (%)", minval=0.0, maxval=15.0, step=0.1)
r_star           = input.float(1.0, "r* (%)", minval=-5.0, maxval=10.0, step=0.1)
phi_pi           = input.float(0.5, "He so lam phat", minval=0.0, maxval=2.0, step=0.05)
phi_y            = input.float(0.5, "He so GDP gap", minval=0.0, maxval=2.0, step=0.05)
policy_z_len_m   = input.int(60, "Lookback policy gap", minval=24, maxval=240)

w_infl           = input.float(0.40, "Trong so rui ro: lam phat", minval=0, maxval=1, step=0.05)
w_pol            = input.float(0.30, "Trong so rui ro: lai suat", minval=0, maxval=1, step=0.05)
w_grow           = input.float(0.20, "Trong so rui ro: tang truong", minval=0, maxval=1, step=0.05)
w_drv            = input.float(0.10, "Trong so rui ro: drivers", minval=0, maxval=1, step=0.05)

// =====================================================
// D) WORDING DICTIONARY (LOCKED)
// =====================================================
const string WD_PCTL_NAME      = "PCTL"
const string WD_PCTL_LEGEND    = "50=binh thuong | 80+=rat cao"
const string WD_RISK_LEGEND    = "B0 rat thap | B1 thap | B2 vua | B3 cao | B4 rat cao"

const string WD_HDR_SUMMARY    = "TOM TAT"
const string WD_HDR_MAIN       = "CHI SO CHINH (DE HIEU)"
const string WD_HDR_DO         = "NEN LAM (NGAN GON)"
const string WD_HDR_WATCH      = "KHI NAO NEN CHU Y"
const string WD_HDR_DEBUG      = "DEBUG (NGAN GON)"

const string WD_COL_METRIC     = "Chi tieu"
const string WD_COL_VALUE      = "Gia tri"
const string WD_COL_PCTL       = "PCTL"
const string WD_COL_MEANING    = "Y nghia"

const string WD_INFL           = "Lam phat"
const string WD_FORECAST       = "Du bao"
const string WD_VS_TREND       = "So voi trend"
const string WD_MOM            = "Dong luc"
const string WD_SURPRISE       = "Lech du bao"
const string WD_TIGHT          = "Ap luc lai suat"
const string WD_POLICY         = "Lai suat dieu hanh"
const string WD_INTERBANK      = "Lien ngan hang"
const string WD_REALRATE       = "Lai thuc"
const string WD_POLICYGAP      = "Policy gap"
const string WD_GDP            = "GDP"
const string WD_PHASE          = "Pha"
const string WD_COST           = "Chi phi"
const string WD_YC             = "Yield curve"
const string WD_SLOPE          = "Do doc (10Y-2Y)"
const string WD_RISK           = "Rui ro"
const string WD_ACCURACY       = "Do tin (du bao)"

const string WD_STATE_NA       = "Chua du du lieu"
const string WD_STATE_FLAT     = "Di ngang"
const string WD_STATE_HOT      = "Co dau hieu nong lai"
const string WD_STATE_COOL     = "Dang ha nhiet"

const string WD_RATE_TIGHT     = "Lai suat: dang that"
const string WD_RATE_EASY      = "Lai suat: dang de"
const string WD_RATE_NEUTRAL   = "Lai suat: trung tinh"
const string WD_RATE_UNKNOWN   = "Lai suat: chua ro"

const string WD_PHASE_EXPAND   = "Pha: mo rong"
const string WD_PHASE_STABLE   = "Pha: on dinh"
const string WD_PHASE_SLOW     = "Pha: cham lai"

const string WD_COST_UP        = "Chi phi: dang tang"
const string WD_COST_DOWN      = "Chi phi: dang giam"
const string WD_COST_NEUTRAL   = "Chi phi: trung tinh"
const string WD_COST_OFF       = "Chi phi: OFF"

const string WD_YC_INV         = "YC: dao nguoc"
const string WD_YC_NORM        = "YC: binh thuong"
const string WD_YC_OFF         = "YC: OFF"

const string WD_EVAL_OK        = "Tin hieu: on dinh"
const string WD_EVAL_WATCH     = "Tin hieu: de doi"
const string WD_EVAL_OFF       = "Eval: OFF"

const string WD_HINT_PCTL_DASH = "Neu PCTL '-' thi can them lich su (>=24-60 thang)."
const string WD_HINT_7PANE     = "7 pane = 7 instance (moi instance chon 1 panel)."
const string WD_KXH            = "KHONG XEP HANG"

// =====================================================
// E) HELPERS
// =====================================================
f_round(float x, int d) =>
    float m = math.pow(10.0, d)
    math.round(x * m) / m

f_fmt(float x, int d) =>
    string s = "-"
    if not na(x)
        s := str.tostring(f_round(x, d))
    s

f_fmt_pctl(float x) =>
    na(x) ? "-" : str.tostring(int(math.round(x)))

f_sec(string sym, string tf, float expr) =>
    request.security(sym, tf, expr, barmerge.gaps_off, barmerge.lookahead_off)

// rolling cov/var (khong dung ta.covariance)
f_cov(float x, float y, int length) =>
    float mx = ta.sma(x, length)
    float my = ta.sma(y, length)
    ta.sma((x - mx) * (y - my), length)

f_var(float x, int length) =>
    float mx = ta.sma(x, length)
    ta.sma((x - mx) * (x - mx), length)

// rolling sum (thay ta.sum)
f_rollsum(float src, int length) =>
    float s = 0.0
    for i = 0 to length - 1
        s += nz(src[i])
    s

f_winsor_z(float src, int length, float clip_mult) =>
    float m  = ta.sma(src, length)
    float sd = ta.stdev(src, length)
    float hi = m + clip_mult * sd
    float lo = m - clip_mult * sd
    float clipped = src
    if not na(sd)
        clipped := math.max(lo, math.min(hi, src))
    float cm  = ta.sma(clipped, length)
    float csd = ta.stdev(clipped, length)
    float z = 0.0
    if csd > 0
        z := (src - cm) / csd
    z

f_mad_z(float src, int length) =>
    float med   = ta.percentile_nearest_rank(src, length, 50)
    float mad   = ta.percentile_nearest_rank(math.abs(src - med), length, 50)
    float denom = 1.4826 * mad
    float z = 0.0
    if denom > 0
        z := (src - med) / denom
    z

f_z(float src, int length, float clip_mult) =>
    robustMode == "Fully-robust MAD" ? f_mad_z(src, length) : f_winsor_z(src, length, clip_mult)

f_arr_push_float(float[] arr, float val, int maxlen) =>
    if not na(val)
        array.push(arr, val)
        if array.size(arr) > maxlen
            array.shift(arr)

f_arr_pctl(float[] arr, float val) =>
    float p = na
    int n = array.size(arr)
    if n > 0 and not na(val)
        int cnt = 0
        for i = 0 to n - 1
            float x = array.get(arr, i)
            if not na(x) and x <= val
                cnt += 1
        p := 100.0 * cnt / n
    p

f_pctl_bg_dir(float p, bool highIsBad) =>
    color bg = color.new(color.gray, 85)
    if not pctlColorOn
        bg := color.new(color.black, 0)
    else
        if na(p)
            bg := color.new(color.gray, 85)
        else
            bool hi = p >= 80
            bool midhi = p >= 60 and p < 80
            bool midlo = p >= 40 and p < 60
            bool lo = p >= 20 and p < 40
            if highIsBad
                bg := hi ? color.new(color.red, 65) :
                      midhi ? color.new(color.orange, 70) :
                      midlo ? color.new(color.gray, 85) :
                      lo ? color.new(color.green, 82) :
                      color.new(color.green, 68)
            else
                bg := hi ? color.new(color.green, 68) :
                      midhi ? color.new(color.green, 82) :
                      midlo ? color.new(color.gray, 85) :
                      lo ? color.new(color.orange, 70) :
                      color.new(color.red, 65)
    bg

f_bucket(float p) =>
    string b = "B2"
    if not na(p)
        if p < 20
            b := "B0"
        else if p < 40
            b := "B1"
        else if p < 60
            b := "B2"
        else if p < 80
            b := "B3"
        else
            b := "B4"
    b

f_risk_bg(string bucket) =>
    color bg = color.new(color.gray, 85)
    if not riskColorOn
        bg := color.new(color.black, 0)
    else
        bg := bucket == "B4" ? color.new(color.red, 60) :
              bucket == "B3" ? color.new(color.orange, 65) :
              bucket == "B2" ? color.new(color.gray, 85) :
              bucket == "B1" ? color.new(color.green, 82) :
              color.new(color.green, 68)
    bg

f_risk_text(string bucket) =>
    bucket == "B4" ? "Rui ro rat cao" :
     bucket == "B3" ? "Rui ro cao" :
     bucket == "B2" ? "Rui ro vua" :
     bucket == "B1" ? "Rui ro thap" :
     "Rui ro rat thap"

// PCTL text: numeric -> number, else "KHONG XEP HANG"
f_pctl_text(float p, bool ranked) =>
    ranked ? f_fmt_pctl(p) : WD_KXH

// =====================================================
// F) EXPECTATION ENSEMBLE (Monthly)
// =====================================================
f_pi_trend(float src) => ta.ema(src, infl_trend_len_m)

f_pi_ewma(float src) =>
    var float ew = na
    if na(ew[1])
        ew := src
    else
        ew := ewma_lambda * src + (1.0 - ewma_lambda) * ew[1]
    ew

f_pi_ar1_expect(float src) =>
    float y    = src[1]
    float x    = src[2]
    float cov  = f_cov(y, x, ar1_len_m)
    float varx = f_var(x, ar1_len_m)
    float beta = varx > 0 ? cov / varx : 0.0
    float my = ta.sma(y, ar1_len_m)
    float mx = ta.sma(x, ar1_len_m)
    float a  = my - beta * mx
    a + beta * y

f_pi_ensemble_expect(float src) =>
    float tr = f_pi_trend(src)
    float ew = f_pi_ewma(src)
    float ar = f_pi_ar1_expect(src)
    float wsum = w_trend + w_ewma + w_ar1
    float wt = wsum > 0 ? w_trend / wsum : 1.0
    float we = wsum > 0 ? w_ewma  / wsum : 0.0
    float wa = wsum > 0 ? w_ar1   / wsum : 0.0
    wt * tr[1] + we * ew[1] + wa * ar

float pi_m       = f_sec(sym_infl, "M", close)
float pi_trend_m = f_sec(sym_infl, "M", f_pi_trend(close))
float pi_gap_m   = pi_m - pi_trend_m
float dpi_m      = f_sec(sym_infl, "M", close - close[1])
float pi_e_m     = f_sec(sym_infl, "M", f_pi_ensemble_expect(close))
float surprise_m = f_sec(sym_infl, "M", close - f_pi_ensemble_expect(close))

// =====================================================
// G) DRIVERS + BOT
// =====================================================
float ppi_q       = na
float ppi_trend_q = na
float ppi_gap_q   = na
float fx_mom_m    = na
float oil_mom_m   = na
float z_ppi_gap   = na
float z_fx_mom    = na
float z_oil_mom   = na
float IDI         = na

if useDrivers
    ppi_q       := f_sec(sym_ppi, "3M", close)
    ppi_trend_q := f_sec(sym_ppi, "3M", ta.ema(close, ppi_trend_len_q))
    ppi_gap_q   := ppi_q - ppi_trend_q
    fx_mom_m    := f_sec(sym_fx,  "M", math.log(close / close[1]))
    oil_mom_m   := f_sec(sym_oil, "M", math.log(close / close[1]))
    z_ppi_gap   := f_z(ppi_gap_q, ppi_z_len_q, drv_clip)
    z_fx_mom    := f_z(fx_mom_m,  drv_z_len_m, drv_clip)
    z_oil_mom   := f_z(oil_mom_m, drv_z_len_m, drv_clip)
    IDI         := 0.5 * z_ppi_gap + 0.3 * z_fx_mom + 0.2 * z_oil_mom

float bot_m = na
float bot_z = na
if useExternalBOT
    bot_m := f_sec(sym_bot, "M", close)
    bot_z := f_z(bot_m, 60, 2.5)

// =====================================================
// H) RATES
// =====================================================
float i_policy_m = f_sec(sym_pol, "M", close)
float i_ib_m     = f_sec(sym_ib,  "M", close)
float di_ib_m    = f_sec(sym_ib,  "M", close - close[1])

float r_real_m   = i_policy_m - pi_e_m
bool  isNewMonth = timeframe.change("M")
float alpha_m    = 2.0 / (rreal_ema_len_m + 1.0)

var float rreal_ema_m = na
if isNewMonth
    rreal_ema_m := na(rreal_ema_m) ? r_real_m : alpha_m * r_real_m + (1.0 - alpha_m) * rreal_ema_m

float r_real_gap_m = r_real_m - rreal_ema_m
float tight_idx = f_z(r_real_gap_m, rate_z_len_m, rate_clip) + 0.5 * f_z(di_ib_m, rate_z_len_m, rate_clip)

// =====================================================
// I) GDP
// =====================================================
float gdp_q       = f_sec(sym_gdp, "3M", close)
float gdp_trend_q = f_sec(sym_gdp, "3M", ta.ema(close, gdp_trend_len_q))
float gdp_gap_q   = gdp_q - gdp_trend_q
float grow_idx    = f_z(gdp_gap_q, gdp_z_len_q, gdp_clip)

// =====================================================
// J) TAYLOR GAP
// =====================================================
float i_implied  = r_star + pi_m + phi_pi * (pi_m - pi_target) + phi_y * gdp_gap_q
float policy_gap = i_policy_m - i_implied

// =====================================================
// K) YIELD CURVE
// =====================================================
float vn10y_m = na
float vn02y_m = na
float yc_slope_m = na
float yc_idx = na

if useYieldCurve
    vn10y_m := f_sec(sym_vn10y, "M", close)
    vn02y_m := f_sec(sym_vn02y, "M", close)
    yc_slope_m := vn10y_m - vn02y_m
    yc_idx := f_z(yc_slope_m, 60, 2.5)

// =====================================================
// L) RISK SCORE + PARTS
// =====================================================
float infl_gap_idx = f_z(pi_gap_m, infl_z_len_m, infl_clip)
float mom_idx      = f_z(dpi_m,    infl_z_len_m, infl_clip)
float sur_idx      = f_z(surprise_m, infl_z_len_m, infl_clip)

float S_infl = infl_gap_idx + 0.5 * mom_idx + 0.5 * sur_idx
float S_pol  = tight_idx + 0.5 * f_z(policy_gap, policy_z_len_m, 2.5)
float S_grow = -grow_idx
float S_drv  = useDrivers ? 0.5 * IDI : na
float S_ext  = useExternalBOT ? -0.2 * bot_z : na

float RiskScore = w_infl * S_infl + w_pol * S_pol + w_grow * S_grow + w_drv * (useDrivers ? S_drv : 0.0) + (useExternalBOT ? S_ext : 0.0)

// =====================================================
// M) PCTL PACK (arrays)
// =====================================================
var float[] arr_risk   = array.new_float()
var float[] arr_pi     = array.new_float()
var float[] arr_epi    = array.new_float()
var float[] arr_gap    = array.new_float()
var float[] arr_dpi    = array.new_float()
var float[] arr_sur    = array.new_float()

var float[] arr_ipol   = array.new_float()
var float[] arr_iib    = array.new_float()
var float[] arr_diib   = array.new_float()
var float[] arr_rreal  = array.new_float()
var float[] arr_tight  = array.new_float()
var float[] arr_polgap = array.new_float()

var float[] arr_gdp    = array.new_float()
var float[] arr_gdpgap = array.new_float()
var float[] arr_grow   = array.new_float()

var float[] arr_idi    = array.new_float()
var float[] arr_zppi   = array.new_float()
var float[] arr_zfx    = array.new_float()
var float[] arr_zoil   = array.new_float()

var float[] arr_yc     = array.new_float()
var float[] arr_ycidx  = array.new_float()

var float[] arr_sinfl  = array.new_float()
var float[] arr_spol   = array.new_float()
var float[] arr_sgrow  = array.new_float()
var float[] arr_sdrv   = array.new_float()

var float[] arr_errabs = array.new_float()
var float[] arr_mae    = array.new_float()
var float[] arr_rmse   = array.new_float()
var float[] arr_churn  = array.new_float()

float err_abs_m = math.abs(surprise_m)
float mae24_m   = na
float rmse24_m  = na
if useEvaluation
    mae24_m  := ta.sma(err_abs_m, 24)
    rmse24_m := math.sqrt(ta.sma(surprise_m * surprise_m, 24))

int stateId = 0
bool ok_pi = not na(pi_m)
bool ok_tr = not na(pi_trend_m)
bool ok_epi = not na(pi_e_m)
bool ok_gap = not na(pi_gap_m)
bool ok_dpi = not na(dpi_m)
bool ok_sur = not na(surprise_m)
bool hasDataP1 = ok_pi and ok_tr and ok_epi and ok_gap and ok_dpi and ok_sur

bool cond_hot  = hasDataP1 and (dpi_m > 0) and ((pi_gap_m > 0) or (surprise_m > 0))
bool cond_cool = hasDataP1 and (pi_gap_m < 0) and (dpi_m < 0)

stateId := hasDataP1 ? (cond_hot ? 1 : (cond_cool ? -1 : 0)) : 0
float churn12 = useEvaluation ? f_rollsum(stateId != stateId[1] ? 1.0 : 0.0, 12) : na

if isNewMonth
    // P1
    f_arr_push_float(arr_pi,     pi_m,        120)
    f_arr_push_float(arr_epi,    pi_e_m,      120)
    f_arr_push_float(arr_gap,    pi_gap_m,    120)
    f_arr_push_float(arr_dpi,    dpi_m,       120)
    f_arr_push_float(arr_sur,    surprise_m,  120)

    // P2
    f_arr_push_float(arr_ipol,   i_policy_m,  120)
    f_arr_push_float(arr_iib,    i_ib_m,      120)
    f_arr_push_float(arr_diib,   di_ib_m,     120)
    f_arr_push_float(arr_rreal,  r_real_m,    120)
    f_arr_push_float(arr_tight,  tight_idx,   120)
    f_arr_push_float(arr_polgap, policy_gap,  120)

    // P3
    f_arr_push_float(arr_gdp,    gdp_q,       120)
    f_arr_push_float(arr_gdpgap, gdp_gap_q,   120)
    f_arr_push_float(arr_grow,   grow_idx,    120)

    // P4 (Drivers idx lines)
    f_arr_push_float(arr_idi,    IDI,         120)
    f_arr_push_float(arr_zppi,   z_ppi_gap,   120)
    f_arr_push_float(arr_zfx,    z_fx_mom,    120)
    f_arr_push_float(arr_zoil,   z_oil_mom,   120)

    // P5
    f_arr_push_float(arr_yc,     yc_slope_m,  120)
    f_arr_push_float(arr_ycidx,  yc_idx,      120)

    // P6 parts
    f_arr_push_float(arr_sinfl,  S_infl,      120)
    f_arr_push_float(arr_spol,   S_pol,       120)
    f_arr_push_float(arr_sgrow,  S_grow,      120)
    f_arr_push_float(arr_sdrv,   S_drv,       120)

    // Risk
    f_arr_push_float(arr_risk,   RiskScore,   120)

    // P7 eval
    if useEvaluation
        f_arr_push_float(arr_errabs, err_abs_m, 120)
        f_arr_push_float(arr_mae,    mae24_m,   120)
        f_arr_push_float(arr_rmse,   rmse24_m,  120)
        f_arr_push_float(arr_churn,  churn12,   120)

// PCTL values
float p_pi     = f_arr_pctl(arr_pi,     pi_m)
float p_epi    = f_arr_pctl(arr_epi,    pi_e_m)
float p_gap    = f_arr_pctl(arr_gap,    pi_gap_m)
float p_dpi    = f_arr_pctl(arr_dpi,    dpi_m)
float p_sur    = f_arr_pctl(arr_sur,    surprise_m)

float p_ipol   = f_arr_pctl(arr_ipol,   i_policy_m)
float p_iib    = f_arr_pctl(arr_iib,    i_ib_m)
float p_diib   = f_arr_pctl(arr_diib,   di_ib_m)
float p_rreal  = f_arr_pctl(arr_rreal,  r_real_m)
float p_tight  = f_arr_pctl(arr_tight,  tight_idx)
float p_polgap = f_arr_pctl(arr_polgap, policy_gap)

float p_gdp    = f_arr_pctl(arr_gdp,    gdp_q)
float p_gdpgap = f_arr_pctl(arr_gdpgap, gdp_gap_q)
float p_grow   = f_arr_pctl(arr_grow,   grow_idx)

float p_idi    = f_arr_pctl(arr_idi,    IDI)
float p_zppi   = f_arr_pctl(arr_zppi,   z_ppi_gap)
float p_zfx    = f_arr_pctl(arr_zfx,    z_fx_mom)
float p_zoil   = f_arr_pctl(arr_zoil,   z_oil_mom)

float p_yc     = f_arr_pctl(arr_yc,     yc_slope_m)
float p_ycidx  = f_arr_pctl(arr_ycidx,  yc_idx)

float p_sinfl  = f_arr_pctl(arr_sinfl,  S_infl)
float p_spol   = f_arr_pctl(arr_spol,   S_pol)
float p_sgrow  = f_arr_pctl(arr_sgrow,  S_grow)
float p_sdrv   = f_arr_pctl(arr_sdrv,   S_drv)

float p_risk   = f_arr_pctl(arr_risk,   RiskScore)

float p_err    = useEvaluation ? f_arr_pctl(arr_errabs, err_abs_m) : na
float p_mae    = useEvaluation ? f_arr_pctl(arr_mae,    mae24_m)   : na
float p_rmse   = useEvaluation ? f_arr_pctl(arr_rmse,   rmse24_m)  : na
float p_churn  = useEvaluation ? f_arr_pctl(arr_churn,  churn12)   : na

string riskBucket = f_bucket(p_risk)

// =====================================================
// N) WORDING OUTPUT
// =====================================================
string infl_state = not hasDataP1 ? WD_STATE_NA : (cond_cool ? WD_STATE_COOL : (cond_hot ? WD_STATE_HOT : WD_STATE_FLAT))

string stance_vi = WD_RATE_NEUTRAL
if not hasDataP1
    stance_vi := WD_RATE_UNKNOWN
else if (r_real_gap_m > 0) or (not na(p_tight) and p_tight >= 80)
    stance_vi := WD_RATE_TIGHT
else if (r_real_gap_m < 0) or (not na(p_tight) and p_tight <= 40)
    stance_vi := WD_RATE_EASY

string phase_vi = WD_PHASE_STABLE
if not na(grow_idx)
    phase_vi := grow_idx < -0.5 ? WD_PHASE_SLOW : (grow_idx > 0.5 ? WD_PHASE_EXPAND : WD_PHASE_STABLE)

string drv_vi = useDrivers ? (IDI > 0.5 ? WD_COST_UP : (IDI < -0.5 ? WD_COST_DOWN : WD_COST_NEUTRAL)) : WD_COST_OFF
string yc_vi  = useYieldCurve ? ((not na(yc_slope_m) and yc_slope_m < 0) ? WD_YC_INV : WD_YC_NORM) : WD_YC_OFF
string eval_vi = useEvaluation ? ((not na(mae24_m) and mae24_m < 0.20 and not na(churn12) and churn12 <= 2) ? WD_EVAL_OK : WD_EVAL_WATCH) : WD_EVAL_OFF

// =====================================================
// O) PLOTS
// =====================================================
bool showPlots = displayMode != "Chi Bang"

plot(showPlots and panel==1 ? pi_m       : na, "P1 CPI",   linewidth=2, trackprice=true)
plot(showPlots and panel==1 ? pi_trend_m : na, "P1 Trend", linewidth=2, trackprice=true)
plot(showPlots and panel==1 ? pi_gap_m   : na, "P1 Gap",   style=plot.style_histogram)

plot(showPlots and panel==2 ? i_policy_m : na, "P2 Policy", linewidth=2, trackprice=true)
plot(showPlots and panel==2 ? i_ib_m     : na, "P2 IB",     linewidth=2, trackprice=true)
plot(showPlots and panel==2 ? tight_idx  : na, "P2 TightIdx", style=plot.style_histogram)

plot(showPlots and panel==3 ? gdp_q       : na, "P3 GDP", linewidth=2, trackprice=true)
plot(showPlots and panel==3 ? gdp_trend_q : na, "P3 GDP trend", linewidth=2, trackprice=true)
plot(showPlots and panel==3 ? gdp_gap_q   : na, "P3 GDP gap", style=plot.style_histogram)

plot(showPlots and panel==4 ? IDI      : na, "P4 IDI", style=plot.style_histogram)
plot(showPlots and panel==4 ? z_fx_mom : na, "P4 FX (idx)", linewidth=2, trackprice=true)

plot(showPlots and panel==5 ? yc_slope_m : na, "P5 YC slope", linewidth=2, trackprice=true)
plot(showPlots and panel==5 ? yc_idx     : na, "P5 YC idx", style=plot.style_histogram)

plot(showPlots and panel==6 ? RiskScore : na, "P6 RiskScore", style=plot.style_histogram)
plot(showPlots and panel==6 ? S_infl    : na, "P6 Infl part", linewidth=2, trackprice=true)

plot(showPlots and panel==7 and useEvaluation ? err_abs_m : na, "P7 AbsErr", style=plot.style_histogram)
plot(showPlots and panel==7 and useEvaluation ? mae24_m   : na, "P7 MAE24",  linewidth=2, trackprice=true)

// =====================================================
// P) Panel 1 line labels (CPI + Trend)
// =====================================================
var label lblA = na
var label lblB = na

if barstate.islast
    bool okLbl = showLineLabels and showPlots and panel==1 and ok_pi and ok_tr
    if okLbl
        if na(lblA)
            lblA := label.new(bar_index, pi_m, "", style=label.style_label_right, textcolor=color.white, color=color.new(color.black, 0))
        label.set_xy(lblA, bar_index, pi_m)
        label.set_text(lblA, "CPI: " + f_fmt(pi_m, 2))

        if na(lblB)
            lblB := label.new(bar_index, pi_trend_m, "", style=label.style_label_right, textcolor=color.white, color=color.new(color.black, 70))
        label.set_xy(lblB, bar_index, pi_trend_m)
        label.set_text(lblB, "Trend: " + f_fmt(pi_trend_m, 2))
    else
        if not na(lblA)
            label.delete(lblA)
            lblA := na
        if not na(lblB)
            label.delete(lblB)
            lblB := na

// =====================================================
// Q) TABLE (Bloomberg-ish)
// =====================================================
f_tbl_pos() =>
    tblPosOpt == "Top Left" ? position.top_left :
     tblPosOpt == "Bottom Right" ? position.bottom_right :
     tblPosOpt == "Bottom Left" ? position.bottom_left :
     position.top_right

f_tbl_size() =>
    fontOpt == "Tiny" ? size.tiny :
     fontOpt == "Normal" ? size.normal :
     size.small

var table t = table.new(position.top_right, 4, 22, border_width=1)

f_cell(int r, int c, string txt, color bg, color tc, halign) =>
    table.cell(t, c, r, txt,
      bgcolor=bg,
      text_color=tc,
      text_size=f_tbl_size(),
      text_halign=halign,
      text_valign=text.align_center)

f_hdr(int r, string txt) =>
    f_cell(r, 0, txt, color.new(color.gray, 75), color.new(color.white, 0), text.align_left)
    f_cell(r, 1, "",  color.new(color.gray, 75), color.new(color.white, 0), text.align_left)
    f_cell(r, 2, "",  color.new(color.gray, 75), color.new(color.white, 0), text.align_left)
    f_cell(r, 3, "",  color.new(color.gray, 75), color.new(color.white, 0), text.align_left)

// typed pval as float -> safe to pass na
f_row(int r, string k, string v, string ptxt, float pval, bool pHighIsBad, string note) =>
    f_cell(r, 0, k,    color.new(color.black, 0), color.new(color.white, 0), text.align_left)
    f_cell(r, 1, v,    color.new(color.black, 0), color.new(color.white, 0), text.align_right)
    f_cell(r, 2, ptxt, f_pctl_bg_dir(pval, pHighIsBad), color.new(color.white, 0), text.align_center)
    f_cell(r, 3, note, color.new(color.black, 0), color.new(color.white, 0), text.align_left)

f_clear() =>
    for r = 0 to 21
        for c = 0 to 3
            table.cell(t, c, r, "", bgcolor=color.new(color.black, 0), text_color=color.new(color.white, 0), text_size=f_tbl_size())

// =====================================================
// R) DASHBOARD
// =====================================================
if barstate.islast
    table.set_position(t, f_tbl_pos())
    f_clear()

    string pName = panel==1 ? "P1 " + WD_INFL :
                   panel==2 ? "P2 Lai suat" :
                   panel==3 ? "P3 Tang truong" :
                   panel==4 ? "P4 " + WD_COST :
                   panel==5 ? "P5 " + WD_YC :
                   panel==6 ? "P6 " + WD_RISK :
                   "P7 " + WD_ACCURACY

    // Header
    f_cell(0, 0, pName,      color.new(color.black, 0), color.new(color.white, 0), text.align_left)
    f_cell(0, 1, infl_state, color.new(color.black, 0), color.new(color.white, 0), text.align_left)
    f_cell(0, 2, stance_vi,  color.new(color.black, 0), color.new(color.white, 0), text.align_left)
    f_cell(0, 3, f_risk_text(riskBucket) + " (" + riskBucket + ")", f_risk_bg(riskBucket), color.new(color.white, 0), text.align_left)

    // Legend
    f_cell(1, 0, WD_PCTL_NAME,   color.new(color.gray, 85), color.new(color.white, 0), text.align_left)
    f_cell(1, 1, WD_PCTL_LEGEND, color.new(color.gray, 90), color.new(color.white, 0), text.align_left)
    f_cell(1, 2, WD_RISK_LEGEND, color.new(color.gray, 90), color.new(color.white, 0), text.align_left)
    f_cell(1, 3, WD_HINT_7PANE,  color.new(color.gray, 90), color.new(color.white, 0), text.align_left)

    // Summary
    f_hdr(2, WD_HDR_SUMMARY)
    if panel==1
        f_row(3, "CPI", f_fmt(pi_m,2), "P"+f_fmt_pctl(p_pi), p_pi, true, "Muc lam phat YoY")
        f_row(4, WD_FORECAST, f_fmt(pi_e_m,2), "P"+f_fmt_pctl(p_epi), p_epi, true, "Ky vong thang toi")
    else if panel==2
        f_row(3, WD_POLICY, f_fmt(i_policy_m,2), "P"+f_fmt_pctl(p_ipol), p_ipol, true, "Cao=that hon")
        f_row(4, WD_TIGHT,  f_fmt(tight_idx,2),  "P"+f_fmt_pctl(p_tight), p_tight, true, "Chi so (cao=that)")
    else if panel==3
        f_row(3, WD_GDP, f_fmt(gdp_q,2), "P"+f_fmt_pctl(p_gdp), p_gdp, false, "Cao=tot")
        f_row(4, WD_VS_TREND, f_fmt(gdp_gap_q,2), "P"+f_fmt_pctl(p_gdpgap), p_gdpgap, false, "Duong(+)=manh")
    else if panel==4
        f_row(3, "IDI", f_fmt(IDI,2), "P"+f_fmt_pctl(p_idi), p_idi, true, "Tong hop PPI/FX/Oil")
        f_row(4, "PPI(idx)", f_fmt(z_ppi_gap,2), "P"+f_fmt_pctl(p_zppi), p_zppi, true, "Cao=xau")
    else if panel==5
        f_row(3, WD_SLOPE, f_fmt(yc_slope_m,2), "P"+f_fmt_pctl(p_yc), p_yc, false, "Am=dao nguoc")
        f_row(4, "YC(idx)", f_fmt(yc_idx,2), "P"+f_fmt_pctl(p_ycidx), p_ycidx, true, "Bat thuong")
    else if panel==6
        f_row(3, WD_RISK, f_fmt(RiskScore,2), "P"+f_fmt_pctl(p_risk), p_risk, true, "Cao=nhieu ap luc")
        f_row(4, "Ket luan", f_risk_text(riskBucket), WD_KXH, na, true, "Bucket (B0..B4)")
    else
        f_row(3, "Abs err", f_fmt(err_abs_m,2), "P"+f_fmt_pctl(p_err), p_err, true, "Cao=du bao kem")
        f_row(4, "MAE24",  f_fmt(mae24_m,2), "P"+f_fmt_pctl(p_mae), p_mae, true, "TB sai so 24T")

    // Main block
    f_hdr(6, WD_HDR_MAIN)
    f_cell(7,0,WD_COL_METRIC,color.new(color.gray,80),color.new(color.white,0),text.align_left)
    f_cell(7,1,WD_COL_VALUE,color.new(color.gray,80),color.new(color.white,0),text.align_right)
    f_cell(7,2,WD_COL_PCTL,color.new(color.gray,80),color.new(color.white,0),text.align_center)
    f_cell(7,3,WD_COL_MEANING,color.new(color.gray,80),color.new(color.white,0),text.align_left)

    if panel==1
        f_row(8,  WD_INFL,       f_fmt(pi_m,2),       f_pctl_text(p_pi,true),   p_pi,   true,  "Cao=ap luc gia")
        f_row(9,  WD_FORECAST,   f_fmt(pi_e_m,2),     f_pctl_text(p_epi,true),  p_epi,  true,  "Ky vong thang toi")
        f_row(10, WD_VS_TREND,   f_fmt(pi_gap_m,2),   f_pctl_text(p_gap,true),  p_gap,  true,  "Duong(+)=nong hon")
        f_row(11, WD_MOM,        f_fmt(dpi_m,2),      f_pctl_text(p_dpi,true),  p_dpi,  true,  "Thang nay vs thang truoc")
        f_row(12, WD_SURPRISE,   f_fmt(surprise_m,2), f_pctl_text(p_sur,true),  p_sur,  true,  "Duong(+)=cao hon du doan")
        f_row(13, WD_TIGHT,      f_fmt(tight_idx,2),  f_pctl_text(p_tight,true),p_tight,true,  "Cao=that hon")
    else if panel==2
        f_row(8,  WD_POLICY,     f_fmt(i_policy_m,2), f_pctl_text(p_ipol,true),  p_ipol,  true,  "Cao=that hon")
        f_row(9,  WD_INTERBANK,  f_fmt(i_ib_m,2),     f_pctl_text(p_iib,true),   p_iib,   true,  "Cao=thieu thanh khoan")
        f_row(10, WD_REALRATE,   f_fmt(r_real_m,2),   f_pctl_text(p_rreal,true), p_rreal, true,  "Policy - Du bao CPI")
        f_row(11, WD_TIGHT,      f_fmt(tight_idx,2),  f_pctl_text(p_tight,true), p_tight, true,  "Tong hop (cao=that)")
        f_row(12, WD_POLICYGAP,  f_fmt(policy_gap,2), f_pctl_text(p_polgap,true),p_polgap,true,  "Duong(+)=that")
        f_row(13, "IB thay doi", f_fmt(di_ib_m,2),    f_pctl_text(p_diib,true),  p_diib,  true,  "Tang nhanh=canh giac")
    else if panel==3
        f_row(8,  WD_GDP,        f_fmt(gdp_q,2),      f_pctl_text(p_gdp,true),   p_gdp,   false, "Cao=tot")
        f_row(9,  WD_VS_TREND,   f_fmt(gdp_gap_q,2),  f_pctl_text(p_gdpgap,true),p_gdpgap,false, "Duong(+)=manh")
        f_row(10, "Suc manh",    f_fmt(grow_idx,2),   f_pctl_text(p_grow,true),  p_grow,  false, "Chi so (cao=tot)")
        f_row(11, WD_PHASE,      phase_vi,            WD_KXH,                   na,      false, "Mo rong/On dinh/Cham")
        f_row(12, "Ket noi",     "Doc P1+P2",         WD_KXH,                   na,      false, "Tranh doc 1 chieu")
        f_row(13, "Ghi nho",     "GDP la theo quy",   WD_KXH,                   na,      false, "Phan ung cham hon")
    else if panel==4
        f_row(8,  "IDI",          f_fmt(IDI,2),        f_pctl_text(p_idi,true),  p_idi,   true,  "Tong hop chi phi")
        f_row(9,  "PPI (idx)",     f_fmt(z_ppi_gap,2),  f_pctl_text(p_zppi,true), p_zppi,  true,  "Cao=xau")
        f_row(10, "Ty gia (idx)",  f_fmt(z_fx_mom,2),   f_pctl_text(p_zfx,true),  p_zfx,   true,  "Cao=xau")
        f_row(11, "Dau (idx)",     f_fmt(z_oil_mom,2),  f_pctl_text(p_zoil,true), p_zoil,  true,  "Cao=xau")
        f_row(12, "Trang thai",    drv_vi,              WD_KXH,                  na,      true,  "Tom tat nhanh")
        f_row(13, "Goi y",         "Chi phi cao -> canh CPI", WD_KXH,            na,      true,  "Lien ket P1")
    else if panel==5
        f_row(8,  WD_SLOPE,      f_fmt(yc_slope_m,2),  f_pctl_text(p_yc,true),    p_yc,    false, "Am=dao nguoc")
        f_row(9,  "YC (idx)",    f_fmt(yc_idx,2),      f_pctl_text(p_ycidx,true), p_ycidx, true,  "Bat thuong")
        f_row(10, "Trang thai",  yc_vi,                WD_KXH,                   na,      false, "Tin hieu chu ky")
        f_row(11, "Goi y",       "YC dao nguoc -> phong thu", WD_KXH,            na,      false, "Uu tien an toan")
        f_row(12, "Luu y",       "Khong dung YC 1 minh", WD_KXH,                 na,      false, "Doc kem P3")
        f_row(13, "Ket noi",     "YC + GDP",           WD_KXH,                   na,      false, "Tang do tin")
    else if panel==6
        f_row(8,  WD_RISK,       f_fmt(RiskScore,2),   f_pctl_text(p_risk,true),  p_risk,  true, "Cao=nhieu ap luc")
        f_row(9,  "Lam phat (phan)", f_fmt(S_infl,2),  f_pctl_text(p_sinfl,true), p_sinfl, true, "Dong gop P1")
        f_row(10, "Lai suat (phan)", f_fmt(S_pol,2),   f_pctl_text(p_spol,true),  p_spol,  true, "Dong gop P2")
        f_row(11, "Tang truong (phan)", f_fmt(S_grow,2), f_pctl_text(p_sgrow,true), p_sgrow, true, "Yeu -> rui ro")
        f_row(12, "Chi phi (phan)", f_fmt(S_drv,2),    f_pctl_text(p_sdrv,true),  p_sdrv,  true, "Dong gop P4")
        f_row(13, "Ket luan",     f_risk_text(riskBucket), WD_KXH,               na,      true, "Bucket")
    else
        f_row(8,  "Abs err",     f_fmt(err_abs_m,2),   f_pctl_text(p_err,true),   p_err,   true, "Cao=du bao kem")
        f_row(9,  "MAE24",       f_fmt(mae24_m,2),     f_pctl_text(p_mae,true),   p_mae,   true, "TB sai so")
        f_row(10, "RMSE24",      f_fmt(rmse24_m,2),    f_pctl_text(p_rmse,true),  p_rmse,  true, "Phat sai so lon")
        f_row(11, "Churn12",     f_fmt(churn12,0),     f_pctl_text(p_churn,true), p_churn, true, "Cao=hay doi tin hieu")
        f_row(12, "Trang thai",  eval_vi,              WD_KXH,                   na,      true, "De doi/On dinh")
        f_row(13, "Goi y",       "Err cao -> giam ky vong", WD_KXH,              na,      true, "Cho them du lieu")

    // Action + Watch
    f_hdr(14, WD_HDR_DO)
    string act1 = (riskBucket=="B4" or riskBucket=="B3") ? "Phong thu hon" : ((riskBucket=="B1" or riskBucket=="B0") ? "Co the linh hoat" : "Giu can bang")
    string act2 = (riskBucket=="B4" or riskBucket=="B3") ? "Giam don bay"  : "Quan ly rui ro"
    string act3 = (riskBucket=="B4" or riskBucket=="B3") ? "Uu tien chat luong" : "Theo doi tin hieu"

    f_cell(15,0,"Hanh dong",color.new(color.black,0),color.new(color.white,0),text.align_left)
    f_cell(15,1,act1,color.new(color.black,0),color.new(color.white,0),text.align_left)
    f_cell(15,2,act2,color.new(color.black,0),color.new(color.white,0),text.align_left)
    f_cell(15,3,act3,color.new(color.black,0),color.new(color.white,0),text.align_left)

    f_hdr(16, WD_HDR_WATCH)
    string trg1 = panel==1 ? "Lam phat nong lai" :
                  panel==2 ? "Von that hon" :
                  panel==3 ? "Cham lai" :
                  panel==4 ? "Chi phi tang" :
                  panel==5 ? "YC dao nguoc" :
                  panel==6 ? "Rui ro cao" :
                  "Du bao kem"

    string trg2 = panel==1 ? "dpi>0 (2 thang)" :
                  panel==2 ? "ap luc + policy gap" :
                  panel==3 ? "pha xau keo dai" :
                  panel==4 ? "IDI / idx cao" :
                  panel==5 ? "slope < 0" :
                  panel==6 ? "PCTL risk > 80" :
                  "MAE/RMSE tang + churn cao"

    string trg3 = panel==1 ? "gap>0 hoac lech du bao>0" :
                  panel==2 ? "IB tang nhanh" :
                  panel==3 ? "P1/P2 xau cung luc" :
                  panel==4 ? "FX/Oil cung tang" :
                  panel==5 ? "keo dai nhieu thang" :
                  panel==6 ? "uu tien phong thu" :
                  "doi 1-2 thang"

    f_cell(17,0,"Canh bao",color.new(color.black,0),color.new(color.white,0),text.align_left)
    f_cell(17,1,trg1,color.new(color.black,0),color.new(color.white,0),text.align_left)
    f_cell(17,2,trg2,color.new(color.black,0),color.new(color.white,0),text.align_left)
    f_cell(17,3,trg3,color.new(color.black,0),color.new(color.white,0),text.align_left)

    // Debug (expanded sizes)
    if debugOn
        f_hdr(18, WD_HDR_DEBUG)
        f_cell(19,0,"TF/Panel",color.new(color.black,0),color.new(color.white,0),text.align_left)
        f_cell(19,1,"TF="+timeframe.period+" | P="+str.tostring(panel),color.new(color.black,0),color.new(color.white,0),text.align_left)
        f_cell(19,2,"Array size",color.new(color.black,0),color.new(color.white,0),text.align_left)
        f_cell(19,3,
          "riskN="+str.tostring(array.size(arr_risk))+
          " piN="+str.tostring(array.size(arr_pi))+
          " ipolN="+str.tostring(array.size(arr_ipol))+
          " gdpN="+str.tostring(array.size(arr_gdp))+
          " ycN="+str.tostring(array.size(arr_yc))+
          " idiN="+str.tostring(array.size(arr_idi))+
          " evalN="+str.tostring(array.size(arr_errabs)),
          color.new(color.black,0), color.new(color.white,0), text.align_left)

        f_cell(20,0,"Ticker",color.new(color.black,0),color.new(color.white,0),text.align_left)
        f_cell(20,1,"CPI="+sym_infl,color.new(color.black,0),color.new(color.white,0),text.align_left)
        f_cell(20,2,"Rate",color.new(color.black,0),color.new(color.white,0),text.align_left)
        f_cell(20,3,"policy="+sym_pol+" | IB="+sym_ib,color.new(color.black,0),color.new(color.white,0),text.align_left)

        f_cell(21,0,"Goi y",color.new(color.black,0),color.new(color.white,0),text.align_left)
        f_cell(21,1,"PCTL '-' = chua du lich su / ticker NA",color.new(color.black,0),color.new(color.white,0),text.align_left)
        f_cell(21,2,"Note",color.new(color.black,0),color.new(color.white,0),text.align_left)
        f_cell(21,3,WD_HINT_7PANE,color.new(color.black,0),color.new(color.white,0),text.align_left)
